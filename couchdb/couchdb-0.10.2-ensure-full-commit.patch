From ddd88b9612644f219920555e01bf6ddeed465998 Mon Sep 17 00:00:00 2001
From: Randall Leeds <randall.leeds@gmail.com>
Date: Tue, 19 Oct 2010 15:00:34 -0700
Subject: [PATCH] specify Content-Length for _ensure_full_commit

fixes push replication through older nginx (Lounge)
---
 src/couchdb/couch_rep.erl |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/couchdb/couch_rep.erl b/src/couchdb/couch_rep.erl
index b23deee..555c311 100644
--- a/src/couchdb/couch_rep.erl
+++ b/src/couchdb/couch_rep.erl
@@ -608,7 +608,8 @@ commit_to_both(Source, Target, RequiredSeq) ->
 ensure_full_commit(#http_db{} = Target) ->
     Req = Target#http_db{
         resource = "_ensure_full_commit",
-        method = post
+        method = post,
+        headers = [{"Content-Length", 0}]
     },
     {ResultProps} = couch_rep_httpc:request(Req),
     true = proplists:get_value(<<"ok">>, ResultProps),
@@ -633,7 +634,8 @@ ensure_full_commit(#http_db{} = Source, RequiredSeq) ->
     Req = Source#http_db{
         resource = "_ensure_full_commit",
         method = post,
-        qs = [{seq, RequiredSeq}]
+        qs = [{seq, RequiredSeq}],
+        headers = [{"Content-Length", 0}]
     },
     {ResultProps} = couch_rep_httpc:request(Req),
     case proplists:get_value(<<"ok">>, ResultProps) of
-- 
1.7.0.4

